# MySQL、MariaDBでバックアップ、バイナリログから復旧する手順、サンプル (LinuxにMySQLをMariaDBをインストール)

- [MySQL、MariaDBでバックアップ、バイナリログから復旧する手順、サンプル (LinuxにMySQLをMariaDBをインストール)](#mysqlmariadbでバックアップバイナリログから復旧する手順サンプル-linuxにmysqlをmariadbをインストール)
- [背景](#背景)
- [やること](#やること)
- [参考](#参考)
- [注意、制約](#注意制約)
- [前提](#前提)
  - [Linux、Docker、Docker Compose](#linuxdockerdocker-compose)
  - [MariaDBのバージョン](#mariadbのバージョン)
- [解説](#解説)
  - [実行環境](#実行環境)
  - [バイナリログ有効化](#バイナリログ有効化)
  - [バイナリログのファイル確認](#バイナリログのファイル確認)
  - [完全バックアップ](#完全バックアップ)
  - [リストア](#リストア)
- [サンプル補足](#サンプル補足)
  - [Docker環境定義について](#docker環境定義について)

# 背景

DBを使ったWebサイトやシステムなどで、本番の更新・リリース作業を行うときに、

- 作業ミスでテーブルのデータを削除（delete、truncate）してしまった
- 作業ミスでテーブルを削除（drop）してしまった
- そもそも作業手順に問題があって、データやテーブルを削除してしまった

というような話を聞いたことがあります。

作業手順のレビューをしたり、実施時にダブルチェックしたとしても、ミスを完全になくすのは不可能です。
それに、Ansibleのように自動化する方法を使っても、定義を作るのは人なので、誤りを完全に防ぐことも不可能です。

そこで、DBのバックアップとバイナリログで、「○○○○年○○月○○日 ○時○分の時点に戻したい」という願いを実現する方法を探ることにしました。

# やること

`mysqldump`コマンドで完全バックアップをし、さらに、バイナリログを保存して増分バックアップとして使用し、DBを復旧する手順をまとめます。

完全バックアップの作成、および、バイナリログからのSQL作成の際には、データベースを指定することとします。

# 参考

[MySQL 5.6 リファレンスマニュアル - 7.3.1 バックアップポリシーの確立](https://dev.mysql.com/doc/refman/5.6/ja/backup-policy.html)

# 注意、制約

- DBの復旧の際は、DBを更新するサービスを停止して行うことを前提とします。
  - Webサーバやアプリケーションサーバを停止すると、アクセスしてもエラーになります。
  - あらかじめSorryページ等を用意しておくことが望ましいです。
- ファイル（画像、データファイル、レポートなど）のバックアップ、復旧は扱いません。
- 本手順では、Linux等に自前でMySQLあるいはMariaDBをインストールして使用するケースを想定します。
  - AWS RDS, Aurora等のマネージドクラウドサービスでは、別の復旧手順があるので、公式情報等をご参照ください。
    - 余裕があったらAuroraでの復旧手順をまとめてみたい（やるとは言ってません）

# 前提
## Linux、Docker、Docker Compose

Ubuntu 20.04に、Docker、Docker Composeをインストールし、実行することを想定しています。

インストール手順は、手前味噌ですが、[Ubuntu 20.04にDocker、Docker Composeをインストールする手順 - Qiita](https://qiita.com/murakami77/items/98ef607dc4ff0ae9a497)に記載していますので、よろしければご参照ください。

## MariaDBのバージョン

DBは`mariadb:10.7.4`のイメージを使用します。

DBのコンテナでのバージョン確認の例：

```bash
mysql --version
```

↓実行結果

```txt
mysql  Ver 15.1 Distrib 10.7.4-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2
```

# 解説
## 実行環境

docker-compose.ymlを参照

## バイナリログ有効化

DBの設定ファイル`my.cnf`に、バイナリログを有効化するための設定を追記します。

```cnf
#バイナリログ有効化
log-bin=mysql-bin
```

設定ファイルについては、本サンプル（`mariadb:10.7.4`イメージのコンテナ）では`/etc/alternatives/my.cnf`ですが、環境によっては`/etc/my.cnf`に直接書かれている可能性もあり、設定する環境のファイルを調べます。

なお、本サンプルでは、更新する前の`my.cnf`を予め取得し、さらにバイナリログ有効化の設定を追記した、`my.cnf`の完全版のファイルを、`db/my.cnf`に置いてあります。



## バイナリログのファイル確認

`mysql`コマンドで`root`ユーザーで接続し、下記SQLを実行します。

```sql
SHOW MASTER STATUS;
```

実行すると、

```txt
MariaDB [(none)]> show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000002 |   109561 |              |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.004 sec)
```

のように、バイナリログの状況が表示されます。

データが更新されるごとに、上記を実行すると`Position`の値が大きくなっていきます。


## 完全バックアップ

定期的に完全バックアップをする際、

```bash
mysqldump --single-transaction --flush-logs --master-data=2 {データベース名} > {バックアップファイル名}
```

--master-data=2
mysqldumpの出力に、バイナリログ情報が書き込まれます。



例えば、本サンプル

```bash
mysqldump --single-transaction --flush-logs --master-data=2 {データベース名} > {バックアップファイル名}
```


## リストア



# サンプル補足
## Docker環境定義について

